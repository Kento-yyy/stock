
<html>
<head>
<meta charset="utf-8"/>
<style>
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans JP', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif; }
      table { border-collapse: collapse; width: 100%; max-width: 100%; table-layout: auto; }
      th, td { border: 1px solid #ddd; padding: 8px 10px; white-space: nowrap; }
      th { background: #f5f5f5; text-align: right; user-select: none; }
      th:first-child, td:first-child { text-align: left; }
      td { text-align: right; }
      tfoot td { font-weight: bold; background: #fafafa; }
      .muted { color: #666; font-size: 12px; }
      .sortable { cursor: pointer; }
      .sort-indicator { margin-left: 6px; color: #888; font-size: 11px; }
      .toolbar { display:flex; align-items:center; flex-wrap: wrap; gap:10px; margin: 8px 0 14px; }
      .toolbar input[type=range]{ width: 280px; }
      .toolbar select { padding: 4px 6px; }
      .toolbar .label { font-weight: 600; }
      .chg { color:#666; font-size:12px; margin-left:4px; white-space:nowrap; }
      .chg .up { color:#0a0; }
      .chg .down { color:#c00; }
      .up { color:#0a0; }
      .down { color:#c00; }
      .table-wrap { overflow-x: auto; }
      .co { color:#444; font-size:12px; margin-left:6px; }
      /* Allow wrapping only on SYMBOL/TYPE columns so names fit */
      table.pf-table th:first-child,
      table.pf-table td:first-child { white-space: normal; overflow-wrap: anywhere; word-break: break-word; }
      table.pf-table td:first-child .co { white-space: normal; }
    </style>
<script>
    (function(){
      
      function fmtUSD(n){ return (isNaN(n) ? '' : n.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})); }
      function fmtJPY(n){ return (isNaN(n) ? '' : Math.round(n).toLocaleString()); }
      function getCellValue(cell, type){
        var dv = cell.getAttribute('data-value');
        if (type === 'num'){
          var v = (dv !== null ? dv : (cell.textContent || '').replace(/,/g,''));
          var n = parseFloat(v);
          return isNaN(n) ? NaN : n;
        } else {
          return (dv !== null ? dv : (cell.textContent || '')).trim().toUpperCase();
        }
      }
      function sortTableEl(table, colIndex, asc){
        if(!table) return;
        var tbody = table.tBodies[0];
        if(!tbody) return;
        var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));
        if(!rows.length) return;
        var ths = table.tHead && table.tHead.rows.length ? table.tHead.rows[0].cells : null;
        var type = (ths && ths[colIndex] && ths[colIndex].getAttribute('data-sort')) || (colIndex === 0 ? 'str' : 'num');
        rows.sort(function(a,b){
          var av = getCellValue(a.cells[colIndex], type);
          var bv = getCellValue(b.cells[colIndex], type);
          if (type === 'num'){
            var aNaN = !(isFinite(av));
            var bNaN = !(isFinite(bv));
            if (aNaN && bNaN) return 0;
            if (aNaN) return 1; // NaN to bottom
            if (bNaN) return -1;
            return asc ? (av - bv) : (bv - av);
          } else {
            return asc ? (String(av).localeCompare(String(bv))) : (String(bv).localeCompare(String(av)));
          }
        });
        rows.forEach(function(r){ tbody.appendChild(r); });
        // update indicators
        var ths2 = table.tHead.rows[0].cells;
        for (var i=0;i<ths2.length;i++){
          var span = ths2[i].querySelector('.sort-indicator');
          if(span) span.textContent = '';
          else { var sp = document.createElement('span'); sp.className = 'sort-indicator'; ths2[i].appendChild(sp); }
        }
        var active = ths2[colIndex].querySelector('.sort-indicator');
        if(active) active.textContent = asc ? '▲' : '▼';
      }
      function sortTable(tableId, colIndex, asc){
        var table = document.getElementById(tableId);
        if(!table) return;
        sortTableEl(table, colIndex, asc);
      }
      window.attachSortHandlers = function(){
        var tables = document.querySelectorAll('table.pf-table');
        if(!tables || !tables.length) return;
        tables.forEach(function(table){
          var thead = table.tHead;
          if (!thead || !thead.rows.length) return;
          var ths = thead.rows[0].cells;
          for (var i=0;i<ths.length;i++){
            var th = ths[i];
            th.classList.add('sortable');
            // 明示的に型を指定（0列目は文字列、それ以外は数値）
            th.setAttribute('data-sort', i === 0 ? 'str' : 'num');
          }
          thead.addEventListener('click', function(ev){
            var th = ev.target && ev.target.closest ? ev.target.closest('th') : null;
            if (!th || !thead.contains(th)) return;
            var idx = Array.prototype.indexOf.call(ths, th);
            if (idx == null || idx < 0) return;
            var asc = th.getAttribute('data-asc') !== 'true';
            Array.prototype.forEach.call(ths, function(h){ h.removeAttribute('data-asc'); var s=h.querySelector('.sort-indicator'); if(s) s.textContent=''; });
            th.setAttribute('data-asc', asc ? 'true' : 'false');
            sortTableEl(table, idx, asc);
          });
        });
      };
      window.loadPortfolio = async function(){
        if (window.__pfLoaded) return;
        try{
          var base = (function(){ try{ return getWorkerBase(); }catch(e){ return null; } })();
          var url = base ? (base + '/api/portfolio_with_prices') : '/api/portfolio';
          var res = await fetch(url);
          var rows = await res.json();
          var jpyBody = document.querySelector('#pf-table-jpy tbody');
          var usdBody = document.querySelector('#pf-table-usd tbody');
          rows.forEach(function(r){
            var tr = document.createElement('tr');
            tr.setAttribute('data-symbol', r.symbol);
            var tdSym = document.createElement('td');
            tdSym.setAttribute('data-value', r.symbol);
            tdSym.style.textAlign = 'left';
            // SYMBOL + optional company name
            var name = (r.company_name || r.name || '').trim();
            tdSym.textContent = r.symbol;
            if (name) { var sp = document.createElement('span'); sp.className = 'co'; sp.textContent = name; tdSym.appendChild(document.createTextNode(' ')); tdSym.appendChild(sp); }
            tr.appendChild(tdSym);
            var tdShares = document.createElement('td');
            var sh = (typeof r.shares === 'number' ? r.shares : parseFloat(r.shares));
            tdShares.setAttribute('data-value', isFinite(sh)? String(sh): '');
            tdShares.textContent = isFinite(sh)? String(sh): '';
            tr.appendChild(tdShares);
            for(var i=0;i<11;i++){ var td=document.createElement('td'); td.setAttribute('data-value',''); tr.appendChild(td); }
            if (/\.T$/i.test(r.symbol)) { if(jpyBody) jpyBody.appendChild(tr); }
            else { if(usdBody) usdBody.appendChild(tr); }
          });
          window.__pfLoaded = true;
        }catch(e){}
      };
      function initMonthly(){}
      window.setupTables = function(){
        if (window.__pfSetupDone) return;
        window.__pfSetupDone = true;
        if (window.attachSortHandlers) window.attachSortHandlers();
        // Initial sort: JPY_VALUE descending for both tables when monthly view is not used
        try{
          var tables = document.querySelectorAll('table.pf-table');
          tables.forEach(function(t){
            var hasBody = t && t.tBodies && t.tBodies.length && t.tBodies[0] && t.tBodies[0].rows && t.tBodies[0].rows.length;
            if (hasBody && t.querySelectorAll('tbody.month-body').length === 0){
              // Clear existing indicators on initial, set desc on JPY_VALUE
              var ths = t.tHead && t.tHead.rows.length ? t.tHead.rows[0].cells : null;
              var idxMap = headerIndexMap(t);
              var jIdx = idxMap['JPY_VALUE'];
              if (ths && ths.length && jIdx != null){
                for (var i=0;i<ths.length;i++){ var s = ths[i].querySelector('.sort-indicator'); if(s) s.textContent=''; ths[i].removeAttribute('data-asc'); }
                ths[jIdx].setAttribute('data-asc','false');
                sortTableEl(t, jIdx, false); // JPY_VALUE desc
              }
            }
          });
        } catch(e){}
        initMonthly();
      };
    })();
    </script>
<script>
    (function(){
      
      function nowStr(){
        var d = new Date();
        var pad = (n)=> String(n).padStart(2,'0');
        return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate())+" "+pad(d.getHours())+":"+pad(d.getMinutes());
      }
      function dateOnly(){
        var d = new Date();
        var pad = (n)=> String(n).padStart(2,'0');
        return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate());
      }
      function timeStr(ts){
        try{
          var d = new Date(ts);
          var pad = (n)=> String(n).padStart(2,'0');
          return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate())+" "+pad(d.getHours())+":"+pad(d.getMinutes());
        }catch(e){ return nowStr(); }
      }
      function guessIsJPY(sym){ return /\.T$/i.test(sym || ''); }
      function numberFromCell(td){ if(!td) return NaN; var dv=td.getAttribute('data-value'); if(dv!=null) return parseFloat(dv); var t=(td.textContent||'').replace(/,/g,''); var n=parseFloat(t); return isNaN(n)?NaN:n; }
      function setNumCell(td, n, fmt, decimals){ if(!td) return; var val = (isFinite(n)? n : NaN); td.setAttribute('data-value', isFinite(val)? String(val): ''); if(!isFinite(val)){ td.textContent=''; return; } if(fmt==='JPY'){ td.textContent = Math.round(val).toLocaleString(); } else { td.textContent = val.toLocaleString(undefined,{minimumFractionDigits:decimals||2, maximumFractionDigits:decimals||2}); } }
      function headerIndexMap(table){
        var map = {};
        if(!table || !table.tHead || !table.tHead.rows.length) return map;
        var ths = table.tHead.rows[0].cells;
        for (var i=0;i<ths.length;i++){
          var txt = (ths[i].textContent||'').toUpperCase().replace(/[\s▲▼]/g,'');
          map[txt] = i;
        }
        return map;
      }
      // Tag columns and cells with data-col for stable addressing regardless of index shifts
      function tagTableColumns(table){
        if(!table || !table.tHead || !table.tHead.rows.length) return;
        var keys = ['SYMBOL','SHARES','USD_PRICE','USD_VALUE','JPY_PRICE','JPY_VALUE'];
        var ths = table.tHead.rows[0].cells;
        var colKey = new Array(ths.length);
        for (var i=0;i<ths.length;i++){
          var txt = (ths[i].textContent||'').toUpperCase().replace(/[\s▲▼]/g,'');
          if (keys.indexOf(txt) >= 0){ ths[i].setAttribute('data-col', txt); colKey[i] = txt; }
        }
        // Disambiguate YoY/MoM/DoD for USD and JPY blocks based on position after *_PRICE
        var norm = [];
        for (var i=0;i<ths.length;i++){ norm[i] = (ths[i].textContent||'').toUpperCase().replace(/[\s▲▼]/g,''); }
        function tagAfterPrice(prefix){
          var pIdx = norm.indexOf(prefix+'_PRICE');
          if (pIdx < 0) return;
          // scan until *_VALUE or end
          for (var j = pIdx + 1; j < ths.length; j++){
            var keytxt = (ths[j].textContent||'').toUpperCase().replace(/[\s▲▼]/g,'');
            if (keytxt === prefix+'_VALUE') break;
            if (keytxt === 'YOY' || keytxt === '1Y') { ths[j].setAttribute('data-col', prefix+'_YOY'); colKey[j] = prefix+'_YOY'; continue; }
            if (keytxt === 'MOM' || keytxt === '1M') { ths[j].setAttribute('data-col', prefix+'_MOM'); colKey[j] = prefix+'_MOM'; continue; }
            if (keytxt === '1D') { ths[j].setAttribute('data-col', prefix+'_1D'); colKey[j] = prefix+'_1D'; continue; }
            if (keytxt === 'DOD') { ths[j].setAttribute('data-col', prefix+'_DOD'); colKey[j] = prefix+'_DOD'; continue; }
            if (keytxt === '3M') { ths[j].setAttribute('data-col', prefix+'_3M'); colKey[j] = prefix+'_3M'; continue; }
            if (keytxt === '6M') { ths[j].setAttribute('data-col', prefix+'_6M'); colKey[j] = prefix+'_6M'; continue; }
          }
        }
        tagAfterPrice('USD');
        tagAfterPrice('JPY');
        function tagRow(row){
          if(!row) return;
          for (var i=0;i<row.cells.length;i++){
            var key = colKey[i];
            if (key) row.cells[i].setAttribute('data-col', key);
          }
        }
        var tb = table.tBodies && table.tBodies[0]; if (tb){ Array.prototype.forEach.call(tb.rows, tagRow); }
        var tf = table.tFoot && table.tFoot.rows && table.tFoot.rows[0]; if (tf) tagRow(tf);
      }
      function getCellByKey(row, key){ return row ? row.querySelector('td[data-col="'+key+'"]') : null; }
      function setPctCell(td, frac){
        if (!td) return;
        if (!isFinite(frac)) { td.setAttribute('data-value',''); td.textContent=''; return; }
        var cls = frac >= 0 ? 'up' : 'down';
        var pct = (frac*100).toFixed(1);
        td.setAttribute('data-value', String(frac));
        td.innerHTML = "<span class='chg'><span class='"+cls+"'>" + (frac>=0?'+':'') + pct + "%</span></span>";
      }
      // Optional proxy endpoint (Cloudflare Workers). Use query param ?api=https://<your-worker>/quote
      function getApiBase(){
        try{
          var p = new URLSearchParams(location.search).get('api');
          if (p) return p.replace(/\/$/, '');
          var ls = localStorage.getItem('PF_API_BASE');
          if (ls) return ls.replace(/\/$/, '');
        }catch(e){}
        return null;
      }
      // WorkerのルートURLを推定（?api に /quote が付いている互換ケースに対応）
      function getWorkerBase(){
        var b = getApiBase();
        if (!b) return null;
        try{
          // normalize: strip trailing /quote or /quote/...
          var u = new URL(b, location.origin);
          if (/\/quote(\/.+)?$/i.test(u.pathname)){
            u.pathname = u.pathname.replace(/\/quote(\/.+)?$/i, '/');
          }
          return u.toString().replace(/\/$/, '');
        }catch(_){
          // fallback string operations
          return b.replace(/\/quote(\/.+)?$/i, '');
        }
      }
      // Persist and restore last successful quotes in localStorage
      function loadCachedQuotes(){
        try{
          var s = localStorage.getItem('PF_LAST_QUOTES');
          if(!s) return null;
          var j = JSON.parse(s);
          if (j && j.quotes && typeof j.t === 'number') return j;
        }catch(e){}
        return null;
      }
      function saveCachedQuotes(quotes){
        try{
          if (quotes && Object.keys(quotes).length){
            localStorage.setItem('PF_LAST_QUOTES', JSON.stringify({ t: Date.now(), quotes: quotes }));
          }
        }catch(e){}
      }
      // ---- Fetch log (last 100 entries) ----
      function _finite(n){ var v = Number(n); return Number.isFinite(v) ? v : undefined; }
      function loadFetchLog(){
        try{
          var s = localStorage.getItem('PF_FETCH_LOG');
          if(!s) return [];
          var a = JSON.parse(s);
          return Array.isArray(a) ? a : [];
        }catch(e){ return []; }
      }
      function pushFetchLog(quotes, apiBase){
        try{
          if (!quotes || !Object.keys(quotes).length) return;
          var snap = {};
          Object.keys(quotes).sort().forEach(function(sym){
            var q = quotes[sym] || {};
            var o = {};
            var p = _finite(q.regularMarketPrice); if (p !== undefined) o.p = p;
            var d1 = _finite(q.prevClose); if (d1 !== undefined) o.d1 = d1;
            var m30 = _finite(q.prevClose30d); if (m30 !== undefined) o.m30 = m30;
            var y365 = _finite(q.prevClose365d); if (y365 !== undefined) o.y365 = y365;
            var j = _finite(q.jpy); if (j !== undefined) o.jpy = j;
            // Percent changes (cache too)
            var uD = _finite(q.usdDoD); if (uD !== undefined) o.uD = uD;
            var uM = _finite(q.usdMoM); if (uM !== undefined) o.uM = uM;
            var uY = _finite(q.usdYoY); if (uY !== undefined) o.uY = uY;
            var jD = _finite(q.jpyDoD); if (jD !== undefined) o.jD = jD;
            var jM = _finite(q.jpyMoM); if (jM !== undefined) o.jM = jM;
            var jY = _finite(q.jpyYoY); if (jY !== undefined) o.jY = jY;
            if (q.currency) o.c = String(q.currency).toUpperCase();
            if (q.source) o.src = String(q.source);
            if (Object.keys(o).length) snap[String(sym).toUpperCase()] = o;
          });
          var log = loadFetchLog();
          log.push({ t: Date.now(), api: apiBase || null, q: snap });
          if (log.length > 100) log = log.slice(-100);
          localStorage.setItem('PF_FETCH_LOG', JSON.stringify(log));
        }catch(e){}
      }
      function renderFetchLog(){
        try{
          var wrap = document.getElementById('pf-fetch-log-wrap');
          if (!wrap){
            wrap = document.createElement('div');
            wrap.id = 'pf-fetch-log-wrap';
            wrap.style.margin = '24px 0';
            var h = document.createElement('h3');
            h.textContent = 'API Fetch Log (Last 100)';
            var btn = document.createElement('button');
            btn.id = 'pf-clear-log';
            btn.textContent = 'ログをクリア';
            btn.style.margin = '6px 0';
            btn.addEventListener('click', function(){ localStorage.removeItem('PF_FETCH_LOG'); renderFetchLog(); });
            var pre = document.createElement('pre');
            pre.id = 'pf-fetch-log';
            pre.style.whiteSpace = 'pre-wrap';
            pre.style.fontSize = '12px';
            pre.style.lineHeight = '1.35';
            pre.style.background = '#f8f8f8';
            pre.style.border = '1px solid #ddd';
            pre.style.padding = '8px';
            pre.style.maxHeight = '320px';
            pre.style.overflow = 'auto';
            wrap.appendChild(h);
            wrap.appendChild(btn);
            wrap.appendChild(pre);
            document.body.appendChild(wrap);
          }
          var preEl = document.getElementById('pf-fetch-log'); if(!preEl) return;
          var log = loadFetchLog();
          var lines = [];
          for (var i = log.length - 1; i >= 0; i--){
            var e = log[i] || {};
            var ts = (typeof e.t === 'number') ? timeStr(e.t) : nowStr();
            var syms = Object.keys(e.q || {}).join(',');
            lines.push('[' + ts + '] api=' + (e.api || '(auto)') + ' symbols=' + syms);
            var q = e.q || {};
            Object.keys(q).forEach(function(sym){
              var d = q[sym] || {};
              var parts = [];
              if ('p' in d) parts.push('p=' + d.p);
              if ('d1' in d) parts.push('d1=' + d.d1);
              if ('m30' in d) parts.push('m30=' + d.m30);
              if ('y365' in d) parts.push('y365=' + d.y365);
              if ('jpy' in d) parts.push('jpy=' + d.jpy);
              if ('uD' in d) parts.push('usdDoD=' + (d.uD>=0?'+':'') + (d.uD*100).toFixed(2) + '%');
              if ('uM' in d) parts.push('usdMoM=' + (d.uM>=0?'+':'') + (d.uM*100).toFixed(2) + '%');
              if ('uY' in d) parts.push('usdYoY=' + (d.uY>=0?'+':'') + (d.uY*100).toFixed(2) + '%');
              if ('jD' in d) parts.push('jpyDoD=' + (d.jD>=0?'+':'') + (d.jD*100).toFixed(2) + '%');
              if ('jM' in d) parts.push('jpyMoM=' + (d.jM>=0?'+':'') + (d.jM*100).toFixed(2) + '%');
              if ('jY' in d) parts.push('jpyYoY=' + (d.jY>=0?'+':'') + (d.jY*100).toFixed(2) + '%');
              if ('c' in d) parts.push('c=' + d.c);
              if ('src' in d) parts.push('src=' + d.src);
              lines.push('  ' + sym + ': ' + parts.join(' '));
            });
            lines.push('');
          }
          preEl.textContent = lines.join('\n');
        }catch(e){}
      }
      var __pfAppliedCache = false;
      var __pfCachedAt = 0;
      async function fetchViaProxy(symbols){
        var base = getApiBase();
        if(!base) throw new Error('no api');
        var qs = encodeURIComponent(symbols.join(','));
        var sep = base.includes('?') ? '&' : '?';
        // Prefer Stooq at the worker, and let it fill missing via Yahoo
        var url1 = base + sep + 'symbols=' + qs + '&prefer=stooq';
        
        var res1 = await fetch(url1, {cache:'no-store'});
        if (res1.ok) {
          try {
            var j1 = await res1.json();
            var out1 = (j1 && j1.quotes) || {};
            if (Object.keys(out1).length) return out1;
          } catch(_) {}
        }
        // Fallback to 's=' query param
        var url2 = base + sep + 's=' + qs + '&prefer=stooq';
        
        var res2 = await fetch(url2, {cache:'no-store'});
        if(!res2.ok) throw new Error('proxy HTTP '+res2.status);
        var j2 = await res2.json();
        var out2 = (j2 && j2.quotes) || {};
        return out2;
      }
      async function fetchViaProxyOne(sym){
        // Fetch a single symbol (plus USDJPY) to avoid batch mix-ups
        var syms = [sym];
        try { if (sym !== 'USDJPY=X') syms.push('USDJPY=X'); } catch(e) {}
        var q = await fetchViaProxy(syms);
        return q || {};
      }
      // Worker base URL from ?api, normalized (strip /quote)
      function getWorkerBase(){
        var b = getApiBase();
        if (!b) return null;
        try{
          var u = new URL(b, location.origin);
          if (/\/quote(\/.+)?$/i.test(u.pathname)){
            u.pathname = u.pathname.replace(/\/quote(\/.+)?$/i, '/');
          }
          return u.toString().replace(/\/$/, '');
        }catch(_){
          return b.replace(/\/quote(\/.+)?$/i, '');
        }
      }
      async function fetchDbPortfolioWithPrices(){
        var base = getWorkerBase(); if (!base) throw new Error('no worker base');
        var res = await fetch(base + '/api/portfolio_with_prices', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP '+res.status);
        var rows = await res.json(); if (!Array.isArray(rows)) throw new Error('invalid response');
        var quotes = {};
        rows.forEach(function(r){
          var sym = String(r.symbol || '').toUpperCase(); if(!sym) return;
          var q = {};
          if (isFinite(r.price)) q.regularMarketPrice = Number(r.price);
          var cur = (r.price_currency || r.currency || '').toUpperCase(); if (cur) q.currency = cur;
          if (isFinite(r.jpy)) q.jpy = Number(r.jpy);
          if (isFinite(r.price_1d)) q.prevClose = Number(r.price_1d);
          if (isFinite(r.price_1m)) q.prevClose30d = Number(r.price_1m);
          if (isFinite(r.price_1y)) q.prevClose365d = Number(r.price_1y);
          if (isFinite(r.jpy_1d)) q.prevJpy = Number(r.jpy_1d);
          if (isFinite(r.jpy_1m)) q.prevJpy30d = Number(r.jpy_1m);
          if (isFinite(r.jpy_1y)) q.prevJpy365d = Number(r.jpy_1y);
          quotes[sym] = q;
        });
        return quotes;
      }
      async function fetchYahoo(symbols){
        if(!symbols || !symbols.length) return {};
        var url = 'https://query1.finance.yahoo.com/v7/finance/quote?symbols=' + encodeURIComponent(symbols.join(','));
        var res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        var j = await res.json();
        var arr = (j && j.quoteResponse && j.quoteResponse.result) || [];
        var out = {};
        arr.forEach(function(r){ if(r && r.symbol){ out[String(r.symbol).toUpperCase()] = r; } });
        return out;
      }
      function mapToStooqSymbols(symbols){
        var map = {}; // stooqSym -> originalSym
        symbols.forEach(function(sym){
          var s = String(sym).toUpperCase();
          if (s === 'USDJPY=X') { map['usdjpy'] = s; return; }
          if (/\.T$/.test(s)) { map[s.replace(/\.T$/,'').toLowerCase()+'.jp'] = s; return; }
          // default to US
          map[s.toLowerCase()+'.us'] = s;
        });
        return map; // keys are stooq symbols
      }
      function parseStooqCSV(text){
        // Expect header like: Symbol,Date,Time,Open,High,Low,Close,Volume
        var out = {};
        if(!text) return out;
        var lines = text.trim().split(/\r?\n/);
        lines.shift();
        lines.forEach(function(line){
          if(!line) return;
          var cols = line.split(',');
          var sym = cols[0];
          var close = parseFloat(cols[6]);
          if (sym && isFinite(close)){
            out[sym.toLowerCase()] = { regularMarketPrice: close };
          }
        });
        return out;
      }
      async function fetchStooq(symbols){
        if(!symbols || !symbols.length) return {};
        var m = mapToStooqSymbols(symbols);
        var stooqSyms = Object.keys(m);
        var url = 'https://stooq.com/q/l/?s=' + encodeURIComponent(stooqSyms.join(',')) + '&f=sd2t2ohlcv&h&e=csv';
        var res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        var txt = await res.text();
        var parsed = parseStooqCSV(txt);
        var out = {};
        Object.keys(parsed).forEach(function(stooqSym){
          var orig = m[stooqSym];
          if (orig) out[orig] = parsed[stooqSym];
        });
        return out;
      }
      function updateTables(quotes){
        var tables = document.querySelectorAll('table.pf-table');
        var totalUsdAll = 0, totalJpyAll = 0;
        var title = document.querySelector('#pf-title, body > h2');
        if(title){ var t = (title.textContent||''); title.textContent = t.replace(/\(.*?\)/, '('+dateOnly()+')'); }
        var last = document.getElementById('pf-last-updated'); if(last){ last.textContent = '最終更新: '+dateOnly(); }
        var usdJpy = quotes['USDJPY=X'] && quotes['USDJPY=X'].regularMarketPrice;
        // Normalize USDJPY: if rate looks inverted (e.g., 0.0067), flip it
        if (isFinite(usdJpy) && usdJpy > 0 && usdJpy < 1) {
          usdJpy = 1 / usdJpy;
        }
        // Load cached quotes to optionally backfill percent fields when missing
        var cached = loadCachedQuotes();
        var cachedQuotes = (cached && cached.quotes) || {};
        
        tables.forEach(function(table){
          try { tagTableColumns(table); } catch(e){}
          var idx = headerIndexMap(table);
          
          var colSym = idx['SYMBOL'];
          var colShares = idx['SHARES'];
          var colUsdP = idx['USD_PRICE'];
          var colUsdV = idx['USD_VALUE'];
          var colJpyP = idx['JPY_PRICE'];
          var colJpyV = idx['JPY_VALUE'];
          if(colSym==null || colShares==null) return;
          var rows = table.tBodies[0] ? Array.prototype.slice.call(table.tBodies[0].rows) : [];
          var sumUsd = 0, sumJpy = 0;
          rows.forEach(function(tr){
            var sym = (tr.getAttribute('data-symbol') || '').trim();
            if(!sym) return;
            var isJPY = guessIsJPY(sym);
            var shares = numberFromCell(getCellByKey(tr,'SHARES') || tr.cells[colShares]);
            var q = quotes[sym.toUpperCase()];
            var priceUsd, priceJpy;
            // Strict: use server-provided JPY when available. For .T, do not fall back to rmp.
            if (q) {
              if (isFinite(q.jpy)) {
                priceJpy = Number(q.jpy);
                if (isFinite(usdJpy)) priceUsd = priceJpy / usdJpy;
              } else if (!isJPY) {
                // Non-JP symbols: derive from currency + rmp
                if (isFinite(q.regularMarketPrice)) {
                  var cur = (q.currency || '').toUpperCase();
                  if (cur === 'JPY') {
                    priceJpy = q.regularMarketPrice;
                    if (isFinite(usdJpy)) priceUsd = priceJpy / usdJpy;
                  } else { // default USD
                    priceUsd = q.regularMarketPrice;
                    if (isFinite(usdJpy)) priceJpy = priceUsd * usdJpy;
                  }
                }
              }
            }
            
            var cellUsdP = getCellByKey(tr,'USD_PRICE') || tr.cells[colUsdP];
            var cellUsdV = getCellByKey(tr,'USD_VALUE') || tr.cells[colUsdV];
            var cellJpyP = getCellByKey(tr,'JPY_PRICE') || tr.cells[colJpyP];
            var cellJpyV = getCellByKey(tr,'JPY_VALUE') || tr.cells[colJpyV];
            var cellUsdYoY = getCellByKey(tr,'USD_YOY');
            var cellUsdMoM = getCellByKey(tr,'USD_MOM');
            var cellUsd3M = getCellByKey(tr,'USD_3M');
            var cellUsd6M = getCellByKey(tr,'USD_6M');
            var cellUsd1D = getCellByKey(tr,'USD_1D') || getCellByKey(tr,'USD_DOD');
            var cellJpyYoY = getCellByKey(tr,'JPY_YOY');
            var cellJpyMoM = getCellByKey(tr,'JPY_MOM');
            var cellJpy3M = getCellByKey(tr,'JPY_3M');
            var cellJpy6M = getCellByKey(tr,'JPY_6M');
            var cellJpy1D = getCellByKey(tr,'JPY_1D') || getCellByKey(tr,'JPY_DOD');
            if (isFinite(priceUsd) || isFinite(priceJpy)) {
              console.log('Price for ' + sym + ': USD=' + priceUsd + ', JPY=' + priceJpy);
            }
            // Percent changes (prefer API-provided; fallback to local computation)
            // USD block
            if (isFinite(priceUsd)){
              var usdDoD = q && q.usdDoD;
              var usdMoM = q && q.usdMoM;
              var usdYoY = q && q.usdYoY;
              var usd3M, usd6M;
              if (!(isFinite(usdDoD))) {
                var prevUsd1 = undefined;
                if (q) {
                  if ((q.currency||'').toUpperCase()==='USD'){
                    prevUsd1 = q.prevClose;
                  } else if (isFinite(usdJpy) && isFinite(q.prevJpy)) {
                    prevUsd1 = q.prevJpy / usdJpy;
                  }
                }
                if (isFinite(prevUsd1) && prevUsd1>0) usdDoD = (priceUsd - prevUsd1)/prevUsd1;
              }
              if (!(isFinite(usdMoM))) {
                var prevUsd30 = undefined;
                if (q) {
                  if ((q.currency||'').toUpperCase()==='USD'){
                    prevUsd30 = q.prevClose30d;
                  } else if (isFinite(usdJpy) && isFinite(q.prevJpy30d)) {
                    prevUsd30 = q.prevJpy30d / usdJpy;
                  }
                }
                if (isFinite(prevUsd30) && prevUsd30>0) usdMoM = (priceUsd - prevUsd30)/prevUsd30;
              }
              // 3M/6M from Yahoo baselines when available
              var prevUsd90 = (q && q.prevClose90d);
              var prevUsd180 = (q && q.prevClose180d);
              if (!isFinite(prevUsd90) && q && isFinite(q.prevJpy90d) && isFinite(usdJpy)) prevUsd90 = q.prevJpy90d / usdJpy;
              if (!isFinite(prevUsd180) && q && isFinite(q.prevJpy180d) && isFinite(usdJpy)) prevUsd180 = q.prevJpy180d / usdJpy;
              if (isFinite(prevUsd90) && prevUsd90>0) usd3M = (priceUsd - prevUsd90)/prevUsd90;
              if (isFinite(prevUsd180) && prevUsd180>0) usd6M = (priceUsd - prevUsd180)/prevUsd180;
              if (!(isFinite(usdYoY))) {
                var prevUsd365 = undefined;
                if (q) {
                  if ((q.currency||'').toUpperCase()==='USD'){
                    prevUsd365 = q.prevClose365d;
                  } else if (isFinite(usdJpy) && isFinite(q.prevJpy365d)) {
                    prevUsd365 = q.prevJpy365d / usdJpy;
                  }
                }
                if (isFinite(prevUsd365) && prevUsd365>0) usdYoY = (priceUsd - prevUsd365)/prevUsd365;
              }
              if (!isFinite(usdDoD) || !isFinite(usdMoM) || !isFinite(usdYoY)){
                // Backfill from cached percent metrics if available
                try{
                  var cq = cachedQuotes[sym.toUpperCase()] || {};
                  if (!isFinite(usdDoD) && isFinite(cq.usdDoD)) usdDoD = cq.usdDoD;
                  if (!isFinite(usdMoM) && isFinite(cq.usdMoM)) usdMoM = cq.usdMoM;
                  if (!isFinite(usdYoY) && isFinite(cq.usdYoY)) usdYoY = cq.usdYoY;
                }catch(_){ }
              }
              // Write USD cells
              setNumCell(cellUsdP, priceUsd, 'USD', 2);
              if (cellUsdV && isFinite(priceUsd) && isFinite(shares)) setNumCell(cellUsdV, priceUsd*shares, 'USD', 2);
              setPctCell(cellUsdYoY, usdYoY);
              setPctCell(cellUsdMoM, usdMoM);
              setPctCell(cellUsd3M, usd3M);
              setPctCell(cellUsd6M, usd6M);
              setPctCell(cellUsd1D, usdDoD);
            }
            // JPY block
            if (isFinite(priceJpy)){
              var jpyDoD = q && q.jpyDoD;
              var jpyMoM = q && q.jpyMoM;
              var jpyYoY = q && q.jpyYoY;
              var jpy3M, jpy6M;
              if (!(isFinite(jpyDoD))) {
                var prevJ1 = q && (q.prevJpy);
                if (!isFinite(prevJ1) && q && ((q.currency||'').toUpperCase()==='JPY' || /\.T$/i.test(sym))) prevJ1 = q.prevClose;
                if (isFinite(prevJ1) && prevJ1>0) jpyDoD = (priceJpy - prevJ1)/prevJ1;
              }
              if (!(isFinite(jpyMoM))) {
                var prevJ30 = q && (q.prevJpy30d);
                if (!isFinite(prevJ30) && q && ((q.currency||'').toUpperCase()==='JPY' || /\.T$/i.test(sym))) prevJ30 = q.prevClose30d;
                if (isFinite(prevJ30) && prevJ30>0) jpyMoM = (priceJpy - prevJ30)/prevJ30;
              }
              // 3M/6M from Yahoo baselines when available (JPY domain)
              var prevJ90 = (q && q.prevJpy90d);
              var prevJ180 = (q && q.prevJpy180d);
              if (!isFinite(prevJ90)) prevJ90 = (q && ((q.currency||'').toUpperCase()==='JPY' || /\.T$/i.test(sym))) ? q.prevClose90d : (isFinite(usdJpy) && isFinite(q && q.prevClose90d) ? (q.prevClose90d*usdJpy) : undefined);
              if (!isFinite(prevJ180)) prevJ180 = (q && ((q.currency||'').toUpperCase()==='JPY' || /\.T$/i.test(sym))) ? q.prevClose180d : (isFinite(usdJpy) && isFinite(q && q.prevClose180d) ? (q.prevClose180d*usdJpy) : undefined);
              if (isFinite(prevJ90) && prevJ90>0) jpy3M = (priceJpy - prevJ90)/prevJ90;
              if (isFinite(prevJ180) && prevJ180>0) jpy6M = (priceJpy - prevJ180)/prevJ180;
              if (!(isFinite(jpyYoY))) {
                var prevJ365 = q && (q.prevJpy365d);
                if (!isFinite(prevJ365) && q && ((q.currency||'').toUpperCase()==='JPY' || /\.T$/i.test(sym))) prevJ365 = q.prevClose365d;
                if (isFinite(prevJ365) && prevJ365>0) jpyYoY = (priceJpy - prevJ365)/prevJ365;
              }
              if (!isFinite(jpyDoD) || !isFinite(jpyMoM) || !isFinite(jpyYoY)){
                try{
                  var cq2 = cachedQuotes[sym.toUpperCase()] || {};
                  if (!isFinite(jpyDoD) && isFinite(cq2.jpyDoD)) jpyDoD = cq2.jpyDoD;
                  if (!isFinite(jpyMoM) && isFinite(cq2.jpyMoM)) jpyMoM = cq2.jpyMoM;
                  if (!isFinite(jpyYoY) && isFinite(cq2.jpyYoY)) jpyYoY = cq2.jpyYoY;
                }catch(_){ }
              }
              // Write JPY cells
              setNumCell(cellJpyP, priceJpy, 'JPY', 0);
              if (cellJpyV && isFinite(priceJpy) && isFinite(shares)) setNumCell(cellJpyV, priceJpy*shares, 'JPY', 0);
              setPctCell(cellJpyYoY, jpyYoY);
              setPctCell(cellJpyMoM, jpyMoM);
              setPctCell(cellJpy3M, jpy3M);
              setPctCell(cellJpy6M, jpy6M);
              setPctCell(cellJpy1D, jpyDoD);
            }
            if(cellUsdV){ var v = numberFromCell(cellUsdV); if(isFinite(v)) sumUsd += v; }
            if(cellJpyV){ var w = numberFromCell(cellJpyV); if(isFinite(w)) sumJpy += w; }
          });
          // update tfoot totals if present
          if(table.tFoot && table.tFoot.rows.length){
            var tfr = table.tFoot.rows[0];
            var tfUsd = (tfr && (tfr.querySelector('td[data-col="USD_VALUE"]') || tfr.cells[colUsdV])) || null;
            var tfJpy = (tfr && (tfr.querySelector('td[data-col="JPY_VALUE"]') || tfr.cells[colJpyV])) || null;
            if (tfUsd) setNumCell(tfUsd, sumUsd, 'USD', 2);
            if (tfJpy) setNumCell(tfJpy, sumJpy, 'JPY', 0);
          }
          // accumulate global totals (skip tables without rows)
          if (rows && rows.length) {
            if (isFinite(sumUsd)) totalUsdAll += sumUsd;
            if (isFinite(sumJpy)) totalJpyAll += sumJpy;
          }
          // re-apply sort if a header has data-asc state
          try{
            var thead = table.tHead; if(thead && thead.rows.length){
              var ths = thead.rows[0].cells;
              for(var i=0;i<ths.length;i++){
                var ascAttr = ths[i].getAttribute('data-asc');
                if(ascAttr === 'true' || ascAttr === 'false'){
                  var asc = (ascAttr === 'true');
                  if (typeof sortTableEl === 'function') sortTableEl(table, i, asc);
                  break; // apply first active sort
                }
              }
            }
          } catch(e){}
        });
        // Update overall totals table (pf-total) if exists
        try{
          var tot = document.getElementById('pf-total');
          if (tot && tot.tFoot && tot.tFoot.rows.length){
            var tfr2 = tot.tFoot.rows[0];
            var tfUsd2 = tfr2 && (tfr2.querySelector('td[data-col="USD_VALUE"]'));
            var tfJpy2 = tfr2 && (tfr2.querySelector('td[data-col="JPY_VALUE"]'));
            var idx2 = headerIndexMap(tot);
            if (!tfUsd2 && idx2['USD_VALUE']!=null) tfUsd2 = tfr2.cells[idx2['USD_VALUE']];
            if (!tfJpy2 && idx2['JPY_VALUE']!=null) tfJpy2 = tfr2.cells[idx2['JPY_VALUE']];
            if (tfUsd2) setNumCell(tfUsd2, totalUsdAll, 'USD', 2);
            if (tfJpy2) setNumCell(tfJpy2, totalJpyAll, 'JPY', 0);
          }
        } catch(e){}
      }
      var __pfRefreshing = false;
      async function refresh(){
        if (__pfRefreshing) return; // avoid overlapping refreshes
        __pfRefreshing = true;
        var btn = document.getElementById('pf-refresh-btn'); if(btn){ btn.disabled = true; btn.textContent='更新中…'; }
        try{
          var syms = [];
          document.querySelectorAll('table.pf-table tbody tr[data-symbol]').forEach(function(tr){ var s=tr.getAttribute('data-symbol'); if(s) syms.push(s); });
          syms = Array.from(new Set(syms.map(function(s){return s.toUpperCase();})));
          if(syms.indexOf('USDJPY=X')<0) syms.push('USDJPY=X');
          var quotes = {};
          var apiBase = getApiBase();
          var workerBase = getWorkerBase();
          
          if (workerBase) {
            // Prefer DB rows when a Worker base is provided
            try { quotes = await fetchDbPortfolioWithPrices(); } catch(e) { quotes = {}; }
            // Fallback to Worker quote proxy
            if (!quotes || Object.keys(quotes).length === 0) {
              try { quotes = await fetchViaProxy(syms); } catch(e2) { quotes = {}; }
            }
            // Fast path: only re-fetch suspicious JP rows (rare) concurrently
            try {
              var codes = new Set(syms.filter(function(s){return /\.T$/i.test(s);}).map(function(s){return parseInt(s,10);}));
              var suspects = syms.filter(function(s){
                if(!/\.T$/i.test(s)) return false;
                var q = quotes[s]; if(!q) return true; // missing
                if (!isFinite(q.jpy)) return true;     // no JPY value
                var pj = Math.round(Number(q.jpy));
                var code = parseInt(s,10);
                // suspicious if equals another JP code (e.g., 7203) that's not own code
                return Number.isInteger(pj) && codes.has(pj) && pj !== code;
              });
              if (suspects.length){
                await Promise.all(suspects.map(async function(sym){
                  try{
                    var over = await fetchViaProxyOne(sym);
                    if (over && over[sym.toUpperCase()]) quotes[sym.toUpperCase()] = over[sym.toUpperCase()];
                  }catch(_){ }
                }));
              }
            } catch(_){ }
          } else if (apiBase) {
            // When explicit API is specified (no workerBase derivable), prefer Worker quote proxy
            try { quotes = await fetchViaProxy(syms); } catch(e) { }
          } else {
            // Prefer Stooq directly, then Yahoo as fallback (no API)
            try { quotes = await fetchStooq(syms); } catch(e) { }
            if (!Object.keys(quotes).length) {
              try { quotes = await fetchYahoo(syms); } catch(e2) { }
            }
          }
          
          if (Object.keys(quotes).length === 0) throw new Error('no data');
          updateTables(quotes);
          saveCachedQuotes(quotes);
          pushFetchLog(quotes, apiBase);
          renderFetchLog();
        } catch(e) {
          // On failure, show cached quotes if available
          var cached = loadCachedQuotes();
          if (cached && cached.quotes && Object.keys(cached.quotes).length){
            updateTables(cached.quotes);
            var last = document.getElementById('pf-last-updated'); if(last){ var ds = String(timeStr(cached.t)||'').slice(0,10); last.textContent = '最終更新: '+ds+'（キャッシュ）'; }
          } else {
            var last2 = document.getElementById('pf-last-updated'); if(last2){ last2.textContent = '更新失敗（ネットワーク/CORS）'; }
          }
        } finally {
          __pfRefreshing = false;
          if(btn){ btn.disabled = false; btn.textContent='更新'; }
        }
      }
      async function readyRefresh(){
        await loadPortfolio();
        if (window.setupTables) window.setupTables();
        var btn = document.getElementById('pf-refresh-btn'); if(btn){ btn.addEventListener('click', refresh); }
        // auto refresh on load and when back online/visible
        // Apply cached quotes first (if any), then refresh network
        try{
          var cached = loadCachedQuotes();
          if (cached && cached.quotes && Object.keys(cached.quotes).length){
            __pfAppliedCache = true; __pfCachedAt = cached.t;
            updateTables(cached.quotes);
            var last = document.getElementById('pf-last-updated'); if(last){ var ds2 = String(timeStr(cached.t)||'').slice(0,10); last.textContent = '最終更新: '+ds2+'（キャッシュ）'; }
          }
        }catch(e){}
        renderFetchLog();
        refresh();
        window.addEventListener('online', refresh);
        document.addEventListener('visibilitychange', function(){ if(document.visibilityState==='visible') refresh(); });
      }
      if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', readyRefresh); else readyRefresh();
    })();
    </script>
</head>
<body>
<h2>ポートフォリオ評価額 (2025-08-28 20:11)  (USD/JPY 表示)</h2>
<div class="toolbar" id="pf-toolbar">
<button id="pf-refresh-btn">更新</button>
<span class="muted" id="pf-last-updated"></span>
</div>
<h3>国内株</h3>
<div class="table-wrap">
<table class="pf-table" id="pf-table-jpy">
<colgroup>
<col style="width:26%"/>
<col style="width:5%"/>
<col style="width:5%"/>
<col style="width:6%"/>
<col style="width:4%"/>
<col style="width:4%"/>
<col style="width:4%"/>
<col style="width:8%"/>
<col style="width:6%"/>
<col style="width:4%"/>
<col style="width:4%"/>
<col style="width:4%"/>
<col style="width:8%"/>
</colgroup>
<thead>
<tr>
<th style="text-align:left">SYMBOL<span class="sort-indicator"></span></th>
<th>SHARES<span class="sort-indicator"></span></th>
<th>PER<span class="sort-indicator"></span></th>
<th>USD_PRICE<span class="sort-indicator"></span></th>
<th>1D<span class="sort-indicator"></span></th>
<th>1M<span class="sort-indicator"></span></th>
<th>1Y<span class="sort-indicator"></span></th>
<th>USD_VALUE<span class="sort-indicator"></span></th>
<th>JPY_PRICE<span class="sort-indicator"></span></th>
<th>1D<span class="sort-indicator"></span></th>
<th>1M<span class="sort-indicator"></span></th>
<th>1Y<span class="sort-indicator"></span></th>
<th>JPY_VALUE<span class="sort-indicator"></span></th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr><td style="text-align:left">TOTAL</td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td></tr>
</tfoot>
</table>
</div>
<h3>米国株</h3>
<div class="table-wrap">
<table class="pf-table" id="pf-table-usd">
<colgroup>
<col style="width:26%"/>
<col style="width:5%"/>
<col style="width:5%"/>
<col style="width:6%"/>
<col style="width:4%"/>
<col style="width:4%"/>
<col style="width:4%"/>
<col style="width:8%"/>
<col style="width:6%"/>
<col style="width:4%"/>
<col style="width:4%"/>
<col style="width:4%"/>
<col style="width:8%"/>
</colgroup>
<thead>
<tr>
<th style="text-align:left">SYMBOL<span class="sort-indicator"></span></th>
<th>SHARES<span class="sort-indicator"></span></th>
<th>PER<span class="sort-indicator"></span></th>
<th>USD_PRICE<span class="sort-indicator"></span></th>
<th>1D<span class="sort-indicator"></span></th>
<th>1M<span class="sort-indicator"></span></th>
<th>1Y<span class="sort-indicator"></span></th>
<th>USD_VALUE<span class="sort-indicator"></span></th>
<th>JPY_PRICE<span class="sort-indicator"></span></th>
<th>1D<span class="sort-indicator"></span></th>
<th>1M<span class="sort-indicator"></span></th>
<th>1Y<span class="sort-indicator"></span></th>
<th>JPY_VALUE<span class="sort-indicator"></span></th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr><td style="text-align:left">TOTAL</td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td></tr>
</tfoot>
</table>
</div>
<h3>全体合計</h3>
<div class="table-wrap">
<table class="pf-table pf-total" id="pf-total">
<colgroup>
<col style="width:26%"/>
<col style="width:5%"/>
<col style="width:5%"/>
<col style="width:6%"/>
<col style="width:4%"/>
<col style="width:4%"/>
<col style="width:4%"/>
<col style="width:8%"/>
<col style="width:6%"/>
<col style="width:4%"/>
<col style="width:4%"/>
<col style="width:4%"/>
<col style="width:8%"/>
</colgroup>
  <thead>
  <tr>
  <th style="text-align:left">TYPE<span class="sort-indicator"></span></th>
  <th>SHARES<span class="sort-indicator"></span></th>
  <th>PER<span class="sort-indicator"></span></th>
  <th>USD_PRICE<span class="sort-indicator"></span></th>
  <th>1D<span class="sort-indicator"></span></th>
  <th>1M<span class="sort-indicator"></span></th>
  <th>1Y<span class="sort-indicator"></span></th>
  <th>USD_VALUE<span class="sort-indicator"></span></th>
  <th>JPY_PRICE<span class="sort-indicator"></span></th>
  <th>1D<span class="sort-indicator"></span></th>
  <th>1M<span class="sort-indicator"></span></th>
  <th>1Y<span class="sort-indicator"></span></th>
  <th>JPY_VALUE<span class="sort-indicator"></span></th>
  </tr>
  </thead>
<tfoot>
<tr><td style="text-align:left">OVERALL TOTAL</td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td><td data-value=""></td></tr>
</tfoot>
</table>
</div>
<p class="muted" id="fx-rate"></p>

<h3 id="db-snap-title" style="display:none">DB Snapshot（現在値と変化率 1m/3m/6m/1y/3y）</h3>
<div class="table-wrap" id="db-snap-wrap" style="display:none">
  <table class="pf-table" id="db-snapshot">
    <colgroup>
      <col style="width:28%"/>
      <col style="width:7%"/>
      <col style="width:6%"/>
      <col style="width:9%"/>
      <col style="width:9%"/>
      <col style="width:6%"/>
      <col style="width:6%"/>
      <col style="width:6%"/>
      <col style="width:6%"/>
      <col style="width:6%"/>
      <col style="width:6%"/>
      <col style="width:5%"/>
    </colgroup>
    <thead>
      <tr>
        <th style="text-align:left">SYMBOL</th>
        <th>SHARES</th>
        <th>CCY</th>
        <th>PRICE</th>
        <th>JPY</th>
        <th>1D</th>
        <th>1M</th>
        <th>3M</th>
        <th>6M</th>
        <th>1Y</th>
        <th>3Y</th>
        <th>UPDATED</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <p class="muted">注: DBに保存された基準値から算出（JPYベース）。?api= でWorkerを指定すると表示されます。</p>
  <div style="margin:6px 0 20px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
    <button id="db-snap-refresh">スナップショット再読込</button>
    <button id="db-refresh-current">現在値のみ更新</button>
    <button id="db-refresh-baselines">基準値のみ更新</button>
    <button id="db-refresh-both">現在値+基準値更新</button>
    <span class="muted" id="db-refresh-status"></span>
  </div>
  
  <script>
    (function(){
      function getApiBase(){
        try{
          var p = new URLSearchParams(location.search).get('api');
          if (p) return p.replace(/\/$/, '');
          var ls = localStorage.getItem('PF_API_BASE');
          if (ls) return ls.replace(/\/$/, '');
        }catch(e){}
        return null;
      }
      function getWorkerBase(){
        var b = getApiBase();
        if (!b) return null;
        try{
          var u = new URL(b, location.origin);
          if (/\/quote(\/.+)?$/i.test(u.pathname)){
            u.pathname = u.pathname.replace(/\/quote(\/.+)?$/i, '/');
          }
          return u.toString().replace(/\/$/, '');
        }catch(_){ return b.replace(/\/quote(\/.+)?$/i, ''); }
      }
      function pct(from, to){
        var a = Number(from), b = Number(to);
        if (!isFinite(a) || !isFinite(b) || a <= 0) return null;
        return (b - a) / a;
      }
      function td(text, align){
        var el = document.createElement('td');
        if (text==null) text = '';
        el.textContent = text;
        if (align) el.style.textAlign = align;
        return el;
      }
      function tdPct(frac){
        var el = document.createElement('td');
        if (!isFinite(frac)) { el.textContent = ''; return el; }
        var v = frac * 100;
        el.textContent = (v>=0?'+':'') + v.toFixed(2) + '%';
        el.style.color = (frac>0?'#0a0':(frac<0?'#c00':'inherit'));
        return el;
      }
      function escapeHtml(s){
        try{
          return String(s).replace(/[&<>"']/g, function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]); });
        }catch(e){ return String(s); }
      }
      async function loadDbSnapshot(){
        var base = getWorkerBase();
        var title = document.getElementById('db-snap-title');
        var wrap = document.getElementById('db-snap-wrap');
        if (!base){ if(title) title.style.display='none'; if(wrap) wrap.style.display='none'; return; }
        try{
          var url = base.replace(/\/$/, '') + '/api/portfolio_with_prices';
          var res = await fetch(url);
          if (!res.ok) throw new Error('HTTP '+res.status);
          var rows = await res.json();
          if (!Array.isArray(rows)) throw new Error('invalid response');
          var tbody = document.querySelector('#db-snapshot tbody');
          if (!tbody) return;
          tbody.innerHTML='';
          rows.forEach(function(r){
            var tr = document.createElement('tr');
            // SYMBOL + optional company name
            var tdSym = document.createElement('td');
            tdSym.style.textAlign = 'left';
            var nm = (r.company_name || r.name || '').trim();
            tdSym.innerHTML = nm ? (r.symbol + " <span class='co'>" + escapeHtml(nm) + "</span>") : r.symbol;
            tr.appendChild(tdSym);
            tr.appendChild(td(isFinite(r.shares)? String(r.shares): ''));
            var ccy = (r.price_currency || r.currency || '').toUpperCase();
            tr.appendChild(td(ccy));
            tr.appendChild(td(isFinite(r.price)? Number(r.price).toFixed(2): ''));
            tr.appendChild(td(isFinite(r.jpy)? Math.round(Number(r.jpy)).toLocaleString(): ''));
            tr.appendChild(tdPct(pct(r.jpy_1d, Number(r.jpy))));
            var p = Number(r.jpy);
            tr.appendChild(tdPct(pct(r.jpy_1m, p)));
            tr.appendChild(tdPct(pct(r.jpy_3m, p)));
            tr.appendChild(tdPct(pct(r.jpy_6m, p)));
            tr.appendChild(tdPct(pct(r.jpy_1y, p)));
            tr.appendChild(tdPct(pct(r.jpy_3y, p)));
            var up = r.updated_at ? String(r.updated_at).replace('T',' ').replace('Z','') : '';
            tr.appendChild(td(up));
            tbody.appendChild(tr);
          });
          if (title) title.style.display='';
          if (wrap) wrap.style.display='';
        }catch(e){ console.warn('db snapshot failed', e); if(title) title.style.display='none'; if(wrap) wrap.style.display='none'; }
      }
      window.loadDbSnapshot = loadDbSnapshot;
      var btn = document.getElementById('db-snap-refresh');
      if (btn) btn.addEventListener('click', function(){ loadDbSnapshot(); });

      async function doCall(path){
        var base = getWorkerBase();
        var status = document.getElementById('db-refresh-status');
        if (!base){ if(status) status.textContent = 'API未指定(?api=...)'; return; }
        try{
          if(status) status.textContent = '実行中...';
          var r = await fetch(base + path, { method: 'POST' });
          var t = await r.text();
          if(!r.ok) throw new Error('HTTP '+r.status+' '+t);
          if(status) status.textContent = 'OK: ' + t;
          await loadDbSnapshot();
        }catch(e){ if(status) status.textContent = '失敗: ' + e; }
      }
      var b1 = document.getElementById('db-refresh-current');
      if (b1) b1.addEventListener('click', function(){ doCall('/api/quotes/refresh-current'); });
      var b2 = document.getElementById('db-refresh-baselines');
      if (b2) b2.addEventListener('click', function(){ doCall('/api/quotes/refresh-baselines'); });
      var b3 = document.getElementById('db-refresh-both');
      if (b3) b3.addEventListener('click', async function(){
        await doCall('/api/quotes/refresh-current');
        await doCall('/api/quotes/refresh-baselines');
      });
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', loadDbSnapshot); else loadDbSnapshot();
    })();
  </script>
</div>
</body>
</html>

<html>
<head>
  <meta charset="utf-8" />
  <title>Quotes Debug Viewer</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans JP', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif; margin: 16px; }
    .toolbar { display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin:8px 0 14px; }
    textarea { width: 100%; height: 60vh; font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; }
    .muted { color:#666; font-size:12px; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; white-space: nowrap; }
    th { background: #f5f5f5; text-align: left; }
    code { background: #f6f8fa; padding: 1px 4px; border-radius: 3px; }
  </style>
  <script>
  (function(){
    function getApiBase(){
      try{
        var p = new URLSearchParams(location.search).get('api');
        if (p) return p.replace(/\/$/, '');
        var ls = localStorage.getItem('PF_API_BASE');
        if (ls) return ls.replace(/\/$/, '');
      }catch(e){}
      return null;
    }
    function getWorkerBase(){
      var b = getApiBase();
      if (!b) return null;
      try{
        var u = new URL(b, location.origin);
        if (/\/quote(\/.+)?$/i.test(u.pathname)){
          u.pathname = u.pathname.replace(/\/quote(\/.+)?$/i, '/');
        }
        return u.toString().replace(/\/$/, '');
      }catch(_){ return b.replace(/\/quote(\/.+)?$/i, ''); }
    }
    async function fetchQuotes(){
      var base = getWorkerBase(); if (!base) throw new Error('API未指定: ?api=...');
      var r = await fetch(base + '/api/quotes', { cache: 'no-store' });
      if (!r.ok) throw new Error('HTTP '+r.status);
      return await r.json();
    }
    function display(obj){
      var ta = document.getElementById('out');
      var meta = document.getElementById('meta');
      var tblBody = document.querySelector('#cols tbody');
      if (ta) ta.value = JSON.stringify(obj, null, 2);
      if (Array.isArray(obj)){
        meta.textContent = 'records: ' + obj.length;
        // collect union of keys
        var keys = new Set();
        obj.forEach(function(r){ Object.keys(r||{}).forEach(function(k){ keys.add(k); }); });
        // render keys table
        tblBody.innerHTML = '';
        Array.from(keys).sort().forEach(function(k){
          var tr = document.createElement('tr');
          var td1 = document.createElement('td'); td1.textContent = k; tr.appendChild(td1);
          var td2 = document.createElement('td');
          // sample value
          var sample;
          for (var i=0;i<obj.length;i++){ if (obj[i] && obj[i].hasOwnProperty(k)) { sample = obj[i][k]; break; } }
          td2.textContent = (sample===undefined || sample===null) ? '' : String(sample);
          tr.appendChild(td2);
          tblBody.appendChild(tr);
        });
      } else {
        meta.textContent = (obj && typeof obj === 'object') ? 'object' : typeof obj;
        tblBody.innerHTML = '';
      }
    }
    async function refresh(){
      var btn = document.getElementById('btn'); if (btn){ btn.disabled = true; btn.textContent = 'Loading...'; }
      var err = document.getElementById('err'); if (err) err.textContent = '';
      try{
        var data = await fetchQuotes();
        display(data);
      }catch(e){
        if (err) err.textContent = 'Error: ' + e;
      } finally {
        if (btn){ btn.disabled = false; btn.textContent = 'Fetch /api/quotes'; }
      }
    }
    function ready(){
      var btn = document.getElementById('btn'); if (btn) btn.addEventListener('click', refresh);
      refresh();
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ready); else ready();
  })();
  </script>
  
</head>
<body>
  <h2>Quotes Debug Viewer</h2>
  <div class="toolbar">
    <button id="btn">Fetch /api/quotes</button>
    <span class="muted">URLに <code>?api=https://xxx.workers.dev/quote</code> を付けて開いてください。</span>
  </div>
  <div id="err" class="muted" style="color:#c00;"></div>
  <div class="muted" id="meta"></div>
  <textarea id="out" readonly></textarea>

  <h3>Detected columns (union)</h3>
  <table id="cols">
    <thead>
      <tr><th>key</th><th>sample value</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</body>
</html>


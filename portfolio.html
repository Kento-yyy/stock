<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ポートフォリオ</title>
  <style>
    table { border-collapse: collapse; }
    th, td { border:1px solid #ccc; padding:4px 8px; }
  </style>
</head>
<body>
  <h2>ポートフォリオ（現在値・変化率付き）</h2>
  <div style="margin:8px 0;">
    <button id="refresh">価格を更新（DB保存）</button>
    <small>URLクエリに <code>?api=https://<worker>.workers.dev</code> を付けると、任意のWorkerに対して実行できます。</small>
  </div>
  <table id="portfolio"></table>
  <script>
    (function(){
      const params = new URLSearchParams(location.search);
      const RAW_API = (params.get('api') || '').replace(/\/$/, '');
      const workerBase = (()=>{
        if (!RAW_API) return '';
        try{
          const u = new URL(RAW_API, location.origin);
          if (/\/quote(\/.+)?$/i.test(u.pathname)){
            u.pathname = u.pathname.replace(/\/quote(\/.+)?$/i, '/');
          }
          return u.toString().replace(/\/$/, '');
        }catch(_){ return RAW_API.replace(/\/quote(\/.+)?$/i, ''); }
      })();
      const apiUrl = (p) => (workerBase ? workerBase + p : p);

      const $btn = document.getElementById('refresh');
      $btn.onclick = async () => {
        $btn.disabled = true; $btn.textContent = '更新中...';
        try {
          const r = await fetch(apiUrl('/api/quotes/refresh'), { method: 'POST' });
          console.log('refresh', await r.text());
          await load();
        } catch(e) { alert('更新に失敗: ' + e); }
        finally { $btn.disabled = false; $btn.textContent = '価格を更新（DB保存）'; }
      };

      function fmtNum(v, d=2){ if (v==null || v!==v) return ''; return Number(v).toFixed(d); }
      function pct(from, to){ if (from==null || to==null) return null; if (!isFinite(from) || !isFinite(to) || from<=0) return null; return (to - from) / from; }
      function fmtPct(x){ if (x==null || x!==x) return ''; const s=(x*100).toFixed(2)+'%'; return s; }
      function tdTxt(text){ const td = document.createElement('td'); td.textContent = text; return td; }
      function tdPct(x){ const td = document.createElement('td'); if (x==null || x!==x){ td.textContent=''; return td; } const v=x*100; td.textContent = v.toFixed(2) + '%'; td.style.color = (x>0?'#d00':(x<0?'#06c':'inherit')); return td; }

      async function load(){
        const res = await fetch(apiUrl('/api/portfolio_with_prices'));
        const rows = await res.json();
        if (!Array.isArray(rows)) { throw new Error('API returned non-array: ' + JSON.stringify(rows).slice(0,200)); }
        const table = document.getElementById('portfolio');
        table.innerHTML = '';
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const headers = [
          'symbol','shares','currency','price','price_ccy','jpy','updated',
          'chg_1m','chg_3m','chg_6m','chg_1y','chg_3y'
        ];
        headers.forEach(h => { const th=document.createElement('th'); th.textContent=h; headerRow.appendChild(th); });
        thead.appendChild(headerRow); table.appendChild(thead);
        const tbody = document.createElement('tbody');
        for (const r of rows){
          const tr = document.createElement('tr');
          const cc = String(r.price_currency || r.currency || '').toUpperCase();
          tr.appendChild(tdTxt(r.symbol));
          tr.appendChild(tdTxt(r.shares));
          tr.appendChild(tdTxt(r.currency||''));
          tr.appendChild(tdTxt(fmtNum(r.price)));
          tr.appendChild(tdTxt(cc));
          tr.appendChild(tdTxt(fmtNum(r.jpy)));
          tr.appendChild(tdTxt(r.updated_at? String(r.updated_at).replace('T',' ').replace('Z','') : ''));
          // percent changes (JPYベースで統一)
          const p = Number(r.jpy);
          const p1m = Number(r.jpy_1m);
          const p3m = Number(r.jpy_3m);
          const p6m = Number(r.jpy_6m);
          const p1y = Number(r.jpy_1y);
          const p3y = Number(r.jpy_3y);
          tr.appendChild(tdPct(pct(p1m, p)));
          tr.appendChild(tdPct(pct(p3m, p)));
          tr.appendChild(tdPct(pct(p6m, p)));
          tr.appendChild(tdPct(pct(p1y, p)));
          tr.appendChild(tdPct(pct(p3y, p)));
          tbody.appendChild(tr);
        }
        table.appendChild(tbody);
      }

      load();
    })();
  </script>
</body>
</html>
